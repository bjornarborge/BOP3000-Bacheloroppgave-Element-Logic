@page "/productpage"
@using Microsoft.AspNetCore.WebUtilities;
@using WebStoreElementLogic.Data;
@using WebStoreElementLogic.Entities;
@using WebStoreElementLogic.Interfaces;
@inject IProductService ProductService;
@inject Microsoft.AspNetCore.Components.NavigationManager NavigationManager

@if (Products == null)
{
    <p><em>Loading Products...</em></p>
}
else
{
    <!-- Search function -->
    <div class="row-col-md-3 pull-left">
        <input type="text" id="txtSearch" class="form-control" placeholder="Search Product Names.."
            @bind="SearchTerm" @bind:event="oninput"/>
    </div>

    @if (DeleteAlert)
    {
        <Alert OnCancel="CancelDelete">
            <h3>Delete Product</h3>
            Are you sure you wish to delete 
            <span class="text-danger text-decoration-underline">@Products[SelectedIndex].Name?</span>
            <div class="d-flex flex-row justify-content-around">
                <button @onclick="CancelDelete" class="btn btn-success mt-3">Cancel</button>
            <button @onclick="() => Delete(Products[SelectedIndex].Id)">Delete </button>
            </div>
        </Alert>
    }

    <!-- Test for searching -->
    <div class="d-flex justify-content-between">
        <div class="container-fluid">
            @if (FilteredProducts != null)
            {
                @foreach (var product in FilteredProducts)
                {
                    <ProductListItem
                    Info="@product"
                    Index="@FilteredProducts.IndexOf(product)"
                    OnSelected="(index) => SelectProduct(FilteredProducts[index])"
                    Selected="@(SelectedIndex == FilteredProducts.IndexOf(product))" />
                }
            }
        </div>
    
        <div class="container-fluid">

            <!-- TODO: better solution -->
            @if (Products != null)
            {
                <button class="btn btn-primary mt-2 bottom-0 mb-4 rounded-pill position-fixed align-self-end d-block" 
                style="z-index: 3; transform: translateX(-5vw);"
                @onclick="New">
                <!-- Activates the method GetNewId-->
            
                    <h3>Add Product</h3>
                </button>
            }

            <div class="container-fluid position-fixed w-50 pe-4">
                @if (SelectedIndex >= 0)
                {
                    <ProductForm 
                    Title="Edit product"
                    SaveLabel="Save changes"
                    DiscardLabel="Discard changes"
                    DeleteButton
                    Info="FilteredProducts[SelectedIndex]"
                    Copy="(Product) FilteredProducts[SelectedIndex].Clone()"
                    OnSave="SaveHandler"
                    OnDelete="DeleteHandler" />


                }
                @if (AddNew)
                {
                    <ProductForm 
                        Title="Add new product"
                         SaveLabel="Add"
                         DiscardLabel="Cancel"
                         Info="newInfo"
                         Copy="(Product) newInfo.Clone()"
                         OnSave="SaveHandler"
                         OnDiscard="Discard" />
                }

            </div>
        </div>
    </div>

}

@code {
    // Search function - all changes
    private string searchTerm;
    private string SearchTerm
    {
        get { return searchTerm; }
        set
        {
            searchTerm = value;
            FilterProducts();
        }
    }

    private int totalPages;
    private int totalRecords;
    private int curPage;
    private int pagerSize;
    private int pageSize;
    private int startPage;
    private int endPage;
    private string sortColumnName = "Id";
    private string sortDirection = "ASC";
    private bool isSortedAscending;
    private string activeSortColumn;
    private List<Product> FilteredProducts;
    // Search function above


    [Parameter]
    public int id { get; set; }

    public List<Product>? Products = new List<Product>();

    private Product newInfo = new Product();

    private bool AddNew = false;
    private bool DeleteAlert = false;
    private bool NoConnection = false;

    private int SelectedIndex = -1;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            newInfo = await ProductService.GetByID(id);
            // Set the page size to 25 products per page
            int pageSize = 25;
            // Get the current page number from the query string
            int pageIndex = GetPageIndexFromQueryString();
            // Store in a new list temporarily to avoid setting Products to null
            List<Product> FetchedProducts = await ProductService.GetProducts(searchTerm, pageIndex, pageSize);
            FilteredProducts = FetchedProducts;
            Products = FilteredProducts.ToList();

        }
        catch (Exception e)
        {
            NoConnection = true;
        }
    }

    // Search- function
    private int GetPageIndexFromQueryString()
    {
        var uri = new Uri(NavigationManager.Uri);
        var queryParameters = QueryHelpers.ParseQuery(uri.Query);
        var pageIndex = 0;
        if (queryParameters.ContainsKey("pageIndex"))
        {
            int.TryParse(queryParameters["pageIndex"], out pageIndex);
        }
        return pageIndex;
    }

    // Changed due to the search- function
    private void SelectProduct(Product product)
    {
        AddNew = false;
        SelectedIndex = FilteredProducts.IndexOf(product);
    }


    // Changed due to the search- function
    private async Task SaveHandler(Product product)
    {
        if (AddNew)
        {
            // Add product to db and array
            await ProductService.Create(product);
            Products.Add(product);

            AddNew = false;
        }
        else
        {
            await ProductService.Update(product);
        }

        // Manually trigger filter
        FilterProducts();

        // If our currently filtered products don't show the new product, reset the filter
        if (!FilteredProducts.Contains(product))
        {
            searchTerm = "";
            FilterProducts();
        }

        // Have the newest product be the selected product
        SelectedIndex = FilteredProducts.IndexOf(product);
    }


    private void DeleteHandler()
    {
        DeleteAlert = true;
    }

    private void CancelDelete()
    {
        DeleteAlert = false;
    }

    protected async Task Delete(int id)
    {
        await ProductService.Delete(id);

        DeleteAlert = false;

        if (SelectedIndex >= 0)
        {
            Products.RemoveAt(SelectedIndex);
            SelectedIndex = -1;
        }
    }

    private async Task New()
    {
        var productsList = await ProductService.GetNextID(0);
        // Checks if the Id is null
        int newId = productsList?.FirstOrDefault()?.Id ?? 0;
        newInfo = new Product { Id = newId };
        SelectedIndex = FilteredProducts.IndexOf(newInfo);
        AddNew = true;

        NavigationManager.NavigateTo("/productpage");

        StateHasChanged();
    }




    private void Discard()
    {
        AddNew = false;
        StateHasChanged();
    }

    // Search- functions from here
    public async Task RefreshRecords(int currentPage)
    {
        var products = await ProductService.ListAllRefresh(SearchTerm, currentPage, pageSize, sortColumnName, sortDirection);
        Products = products;
    }

    public void FilterProducts()
    {
        SelectedIndex = -1;

        Console.WriteLine("FilterProducts called");
        endPage = 0;
        Console.WriteLine($"SearchTerm = {SearchTerm}");
        if (string.IsNullOrWhiteSpace(SearchTerm))
        {
            // If the search term is empty or null, show all products
            FilteredProducts = Products;
        }
        else
        {
            // Otherwise, filter the products based on the search term
            FilteredProducts = Products.Where(p => p.Name.IndexOf(SearchTerm, StringComparison.OrdinalIgnoreCase) >= 0).ToList();
        }
        Console.WriteLine($"FilteredProducts = {FilteredProducts.Count}");
    }




    public void SetPagerSize(string direction)
    {
        if (direction == "forward" && endPage < totalPages)
        {
            startPage = endPage + 1;
            if (endPage + pagerSize < totalPages)
            {
                endPage = startPage + pagerSize - 1;
            }
            else
            {
                endPage = totalPages;
            }
            this.StateHasChanged();
        }
        else if (direction == "back" && startPage > 1)
        {
            endPage = startPage - 1;
            startPage = startPage - pagerSize;
        }
        else
        {
            startPage = 1;
            endPage = totalPages;
        }
    }

}

